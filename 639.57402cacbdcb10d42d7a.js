(self.webpackChunk_converdy_website_builder=self.webpackChunk_converdy_website_builder||[]).push([[639],{0:(e,t,i)=>{"use strict";function r(e){let t="";const{protocol:i,host:r,href:a}=window.location;return t=e?e.startsWith("http")?e:e.startsWith("www")?`${i}//${e}`:e.startsWith("/")?`${i}//${r}${e}`:`${i}//${r}/${e}`:a,t}function a(e,t){const i=r(e),a=new URLSearchParams(new URL(i).search);return a.set("order_secret",t),`${r(e)}?${a.toString()}`}function n(){return this.$route?this.$route.params.projectId:window.__CONVERDY_LOCALIZED__.projectId}function s(e,t){const i=t&&t.length?t[0].slug:"";if(!e)return i;switch(e.type){case"none":return"";case"page":const r=t.find((t=>t.id===e.pageId));if(!r)return i;const{location:{host:a,pathname:n}}=window;return/(generator|website)\.converdy/.test(a)&&n.includes("preview")?`${n.slice(0,n.lastIndexOf("/"))}/${r.settings.slug}`:r.settings.slug;case"external":return e.url}}function o(e){const t=[];return e.customer_info.email||t.push("Please fill in your email address"),e.billing_info.country||t.push("Filling in your country is required"),e.items.length||t.push("You have no items to order! Please select a pricing option"),t}function c(e,t,i,r){const a={};return e&&(a.standard=e/100),t&&(a.reduced=t/100),i&&(a.superReduced=i/100),r&&(a.parking=r/100),a}i.d(t,{iL:()=>l,ZH:()=>p,Z2:()=>a,HN:()=>n,hr:()=>s,_L:()=>o}),i(1349),c(24,10),c(21,6,null,12),c(20),c(25,13,5),c(19,5),c(21,10),c(25),c(20,9),c(24,14),c(19,7),c(24,13,6),c(27,18,5),c(23,13.5,9),c(22,10,5),c(21,12,5),c(21,9,5),c(17,8,3,14),c(18,5),c(21,9),c(23,8,5),c(20,13,6),c(20,9,5),c(20,10),c(22,9.5),c(21,10,4),c(25,12,6),c(20,5);var d=i(373);function l(){return(0,d.Ri)("c-prev-order_secret")||new URLSearchParams(window.location.search).get("order_secret")}function p(){return"something"}},95:e=>{e.exports=function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}},330:(e,t,i)=>{var r=i(5874),a=i(759),n=i(9505),s=i(983);e.exports=function(e,t){return r(e)?e:a(e,t)?[e]:n(s(e))}},399:(e,t,i)=>{"use strict";i.d(t,{A:()=>n});const r=()=>window.__CONVERDY__.api_url;async function a(e,t={}){const i=await fetch(`${r()}${e}`,t);if(i.ok)return await i.json();throw await i.json()}const n={checkVatNumber:async function(e){return(await fetch(`${r()}/public/check_vat_number`,{method:"POST",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify({vat_number:e})})).ok},fetchProduct:async function(e){return await a(`/public/products/${e}`)},fetchStoreConfig:async function(e){return await a(`/public/projects/${e}/storeConfig`)},fetchCompletedOrders:async function(e){return await a(`/public/orders/fetchCompletedOrders?order_secret=${e}`)},payInvoice:async function(e){return await a("/public/payInvoice",{method:"POST",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify(e)})},placeOrder:async function(e){return await a("/public/placeOrder",{method:"POST",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify(e)})},placeUpsell:async function(e){return await a("/public/placeUpsell",{method:"POST",headers:new Headers({"Content-Type":"application/json"}),body:JSON.stringify(e)})},fetchIpDetails:async function(){return await a("/public/ip_details")},fetchPaymentIntegrationId:async function(e){return await a(`/public/payment-integrations?orderSecret=${e}`)}}},462:e=>{var t=Function.prototype.toString;e.exports=function(e){if(null!=e){try{return t.call(e)}catch(e){}try{return e+""}catch(e){}}return""}},476:(e,t,i)=>{var r=i(1200);e.exports=function(e){return r(this,e).get(e)}},552:(e,t,i)=>{var r=i(9438);e.exports=function(e,t){var i=this.__data__,a=r(i,e);return a<0?(++this.size,i.push([e,t])):i[a][1]=t,this}},759:(e,t,i)=>{var r=i(5874),a=i(975),n=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,s=/^\w*$/;e.exports=function(e,t){if(r(e))return!1;var i=typeof e;return!("number"!=i&&"symbol"!=i&&"boolean"!=i&&null!=e&&!a(e))||s.test(e)||!n.test(e)||null!=t&&e in Object(t)}},983:(e,t,i)=>{var r=i(8071);e.exports=function(e){return null==e?"":r(e)}},984:(e,t,i)=>{var r=i(1200);e.exports=function(e){return r(this,e).has(e)}},1022:(e,t,i)=>{var r=i(6821),a=i(7221),n=i(1596),s=i(1992),o=i(552);function c(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=n,c.prototype.has=s,c.prototype.set=o,e.exports=c},1200:(e,t,i)=>{var r=i(95);e.exports=function(e,t){var i=e.__data__;return r(t)?i["string"==typeof t?"string":"hash"]:i.map}},1596:(e,t,i)=>{var r=i(9438);e.exports=function(e){var t=this.__data__,i=r(t,e);return i<0?void 0:t[i][1]}},1908:e=>{var t=/^(?:0|[1-9]\d*)$/;e.exports=function(e,i){var r=typeof e;return!!(i=null==i?9007199254740991:i)&&("number"==r||"symbol"!=r&&t.test(e))&&e>-1&&e%1==0&&e<i}},1992:(e,t,i)=>{var r=i(9438);e.exports=function(e){return r(this.__data__,e)>-1}},2121:(e,t,i)=>{var r=i(8487);e.exports=function(e){var t=r(e,(function(e){return 500===i.size&&i.clear(),e})),i=t.cache;return t}},2275:e=>{e.exports=function(e,t){for(var i=-1,r=null==e?0:e.length,a=Array(r);++i<r;)a[i]=t(e[i],i,e);return a}},2405:(e,t,i)=>{var r=i(8637);e.exports=function(){this.__data__=r?r(null):{},this.size=0}},3077:(e,t,i)=>{var r=i(4856);e.exports=function(e,t,i){"__proto__"==t&&r?r(e,t,{configurable:!0,enumerable:!0,value:i,writable:!0}):e[t]=i}},3784:(e,t,i)=>{var r=i(8637),a=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;return r?void 0!==t[e]:a.call(t,e)}},4069:(e,t,i)=>{var r=i(6766),a=i(1022),n=i(5870);e.exports=function(){this.size=0,this.__data__={hash:new r,map:new(n||a),string:new r}}},4136:(e,t,i)=>{var r=i(1200);e.exports=function(e,t){var i=r(this,e),a=i.size;return i.set(e,t),this.size+=i.size==a?0:1,this}},4228:(e,t,i)=>{var r=i(7787),a=i(7827),n=i(9400),s=i(462),o=/^\[object .+?Constructor\]$/,c=Function.prototype,d=Object.prototype,l=c.toString,p=d.hasOwnProperty,u=RegExp("^"+l.call(p).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=function(e){return!(!n(e)||a(e))&&(r(e)?u:o).test(s(e))}},4583:(module,__unused_webpack_exports,__webpack_require__)=>{class PaymentProcessatorBase{constructor(e){this.paymentProviderId=e.paymentProviderId,this.paymentIntegration=e.paymentIntegration,this.scope=e.scope,this.enviroment=e.enviroment,this.stepCount=e.stepCount,this.data=e.data,this.credentials=e.credentials}}const reqType={json:"application/json",form:"application/x-www-form-urlencoded"},authType={basic:"basic"},events={ORDER_CREATED:"order:created",ORDER_COMPLETED:"order:paid",ORDER_REFUNDED:"order:refunded",ORDER_CANCELLED:"order:cancelled",INVOICE_CREATED:"invoice:created",INVOICE_FINALIZED:"invoice:finalized",INVOICE_PAID:"invoice:paid",TRANSACTION_COMPLETED:"transaction:completed"},round=(e,t)=>Math.round(e*Math.pow(10,t))/Math.pow(10,t);class PaymentProcessator extends PaymentProcessatorBase{constructor(args){return(async()=>{if(super(args),"be"==this.enviroment&&(this.models=eval("require('@converdy/models')")),this.previousStepData={},this.done=!1,this.apiUrl="fe"==this.enviroment?window.__CONVERDY__.api_url:process.env.API_BASE_URL,this.makeSimpleRequest=null,"fe"==this.enviroment?this.makeSimpleRequest=(e,t)=>new Promise((async(i,r)=>{try{i(await fetch(e,t))}catch(e){r(e)}})):this.makeSimpleRequest=eval("require('node-fetch')"),"fe"==this.enviroment?this.sendEmail=async()=>{console.log("This can only be done from the back end")}:this.sendEmail=async(to,from,subject,html,template_id,dynamic_template_data)=>{try{const sendgrid=eval("require('@sendgrid/mail')");sendgrid.setApiKey(eval("process.env.SENDGRID_API_KEY")),await sendgrid.send({to,from,subject,html,template_id,dynamic_template_data})}catch(e){}},this.providers="fe"==this.enviroment?await(await this.makeSimpleRequest(this.apiUrl+"/public/paymentProviders")).json():await this.models.PaymentProvider.find({}),this.paymentProvider=this.paymentProviderId?this.providers.find((e=>e._id==this.paymentProviderId)):this.providers.find((e=>e._id==this.paymentIntegration.paymentProvider._id)),this.currentStep=this.paymentProvider.steps.filter((e=>e.scope==this.scope)).find((e=>e.order==this.stepCount)),"be"==this.enviroment&&this.paymentIntegration&&this.paymentIntegration._id){const e=await this.models.PaymentIntegration.findById(this.paymentIntegration._id);this.paymentIntegration.data||(this.paymentIntegration.data={}),e.data.privateData&&(this.paymentIntegration.data.privateData=e.data.privateData)}return this})()}eval(ob){return Object.keys(ob).reduce(((acc,k)=>("string"==typeof ob[k]?acc[k]=eval(ob[k]):"object"==typeof ob[k]&&(acc[k]=this.eval(ob[k])),acc)),{})}async loadScript(scriptData){return new Promise(((accept,reject)=>{const script=document.createElement("script");if(script.src=eval(scriptData.url),script.async=!0,scriptData.attributes)for(let key of Object.keys(scriptData.attributes))script[key]=eval(scriptData.attributes[key]);document.body.appendChild(script),script.onload=()=>{accept()}}))}async setPaymentIntegration(e){this.paymentIntegration=await this.models.PaymentIntegration.findById(e)}async makeRequest(options){return new Promise((async(a,r)=>{let data={};options?data=this.eval(options):this.currentStep.data&&(data=this.eval(this.currentStep.data));const requestOprions={method:data.method||"POST",headers:{"Content-Type":data.reqType||"application/json"}};if("GET"!=data.method)if(data.reqType)switch(data.reqType){case reqType.json:requestOprions.body=JSON.stringify(data.data);break;case reqType.form:requestOprions.body=eval("require('form-urlencoded')").default(data.data)}else requestOprions.body=JSON.stringify(data.data);data.auth&&data.auth.type===authType.basic&&(requestOprions.headers.Authorization=`Basic ${Buffer.from(`${data.auth.user}:${data.auth.pass||""}`).toString("base64")}`),data.headers&&(requestOprions.headers={...requestOprions.headers,...data.headers});try{a(await(await this.makeSimpleRequest(data.url,requestOprions)).json())}catch(e){r(e)}}))}async incrementStep(){this.stepCount++,this.currentStep=this.paymentProvider.steps.filter((e=>e.scope==this.scope)).find((e=>e.order==this.stepCount)),this.currentStep&&(this.enviroment=this.currentStep.platform)}async getAffiliateSellerFromCaffs(e,t){try{const i=(await this.models.Project.findById(t).lean()).affiliateSettings,{commissionRecipient:r}=i,a=await Promise.all(e.map((async e=>{try{const i=await this.models.AffiliateSeller.findOne({affiliate_id:e.caff,project_id:t,status:"accepted",acceptedHouseRules:!0}).populate("profile_id").lean();if(i)return{...i,timestamp:e.timestamp}}catch(e){console.log(e)}return null}))),n=(e,t)=>{var i=new Date(e);return i.setDate(i.getDate()+t),i},s=a.filter((e=>e&&new Date<n(e.timestamp,e.profile_id.cookieLifetime)));s.sort(((e,t)=>e.timestamp>t.timestamp?1:-1));const o=s[0],c=s[s.length-1];return"first"===r?o._id:c._id}catch(e){console.log(e)}return null}async checkAccess(){return new Promise((async(a,r)=>{try{let decoded=null;{const auth=eval("require('@converdy/firebase/auth')");decoded=await auth.verifyIdToken(this.credentials)}const user=await this.models.User.findOne({login_service_id:decoded.user_id});a(this.data.data.userId==user._id)}catch(e){a(!1)}}))}async processCurrentStep(){if(!this.currentStep.condition||eval(this.currentStep.condition))if(this.currentStep.secure&&!await this.checkAccess())this.done={msg:"unauthorized"};else switch(this.currentStep.type){case"renderFields":let html="";const fields=this.currentStep.data.fields.sort(((e,t)=>e.order-t.order));let values=this.currentStep.data.values;this.data.data&&this.data.data.data&&this.data.data.data.integrationSettings&&(values=this.data.data.data.integrationSettings,this.data.data.data.privateData&&(values={...values,...this.data.data.data.privateData}));for(let e=0;e<fields.length;e++)switch(fields[e].type){case"textBox":html+=`<div class="field ${fields[e].type}">\n                ${fields[e].label?`<label for="integration-field-${fields[e].name}" >${fields[e].label}</label>`:""}\n                 <input id="integration-field-${fields[e].name}" type="text" placeholder="${fields[e].placeholder}" value="${values[fields[e].name]}"></input>\n                 </div>`;break;case"checkBoxList":html+=`<div class="field ${fields[e].type}">\n                  ${fields[e].label?`<label>${fields[e].label}</label>`:""}\n                  ${fields[e].list.map((t=>`<div class="field sub-field">\n                  <label for="ntegration-field-${fields[e].name}-${t.name}"><span>${t.label} </span> <input id="integration-field-${fields[e].name}-${t.name}" ${values[fields[e].name].find((e=>e.name==t.name)).value?"checked":""}  type="checkbox"></input></label>\n                  \n                  </div>\n                  `)).join("")}\n                   </div>`}document.querySelector(this.data.mountPoint).innerHTML=`\n          <div class="payment-integration-data bg-dull-light p-4 mt-4">\n            ${html}\n          </div>\n          <div class="flex hidden payment-integration-error items-center rounded mt-4 Alert_error Alert_pane">\n            <span class="mr-4 Alert_alertIcon">\n              <i class="far fa-times-circle Icon_root Icon_medium"></i>\n            </span>\n            <span class="text-sm Alert_alertTitle"> </span>\n          </div>\n          `;const validate=values=>{let msg=fields.reduce(((acc,field)=>{if(acc)return acc;if(field.validations){const val=values[field.name];acc=field.validations.reduce(((fieldAcc,validation)=>{if(fieldAcc)return fieldAcc;switch(validation.type){case"required":val||(fieldAcc=eval(validation.errMsg));break;case"minItems":val.filter((e=>e.value)).length<validation.value&&(fieldAcc=eval(validation.errMsg))}return fieldAcc}),"")}return acc}),"");return msg&&(document.querySelector(".payment-integration-error .Alert_alertTitle").innerHTML=msg,document.querySelector(".payment-integration-error").classList.remove("hidden")),msg};window.validatePaymenIntegrationAdd=()=>{const e=fields.reduce(((e,t)=>(-1==t.type.toLowerCase().indexOf("list")?e[t.name]=document.querySelector(`#integration-field-${t.name}`).value:e[t.name]=t.list.map((i=>({...e[t.name].find((e=>e.name==i.name)),value:document.querySelector(`#integration-field-${t.name}-${i.name}`).checked}))),e)),values);return{errorMsg:validate(e),values:e}};break;case"loadScript":await this.loadScript(this.currentStep.data);break;case"request":const rs=await this.makeRequest();this.previousStepData={...this.previousStepData,...rs};break;case"createOrder":let order=null,seller_id=null,contact=await this.models.Contact.findOne({project_id:this.data.project_id,funnel_id:this.data.funnel_id,primary_email:this.data.customer_info.email});if(contact||(contact=new this.models.Contact({project_id:this.data.project_id,funnel_id:this.data.funnel_id,first_name:this.data.billing_info.first_name?this.data.billing_info.first_name:"",last_name:this.data.billing_info.last_name?this.data.billing_info.last_name:"",primary_email:this.data.customer_info.email?this.data.customer_info.email:"",primary_phone:this.data.billing_info.phone?this.data.billing_info.phone:""}),console.log("created new contact",contact),console.log("using data",this.data),await contact.save()),"subscriptionPayment"!=this.scope){if(this.data.parent_order_id){const e=await this.models.Order.findById(this.data.parent_order_id);this.data.payment_method=e.payment_method,this.data.customerId=e.customer_id}if(order=new this.models.Order,order.payment_integration=this.paymentIntegration._id.toString(),order.project_id=this.data.project_id,order.funnel_id=this.data.funnel_id,order.coupon_code=this.data.coupon_code,this.data.caffs&&this.data.caffs.length>0&&(seller_id=await this.getAffiliateSellerFromCaffs(this.data.caffs,this.data.project_id),seller_id&&(order.seller_id=seller_id)),order.items=await Promise.all(this.data.items.map((async e=>({pricing_option_id:e.pricing_option_id,quantity:1,product:await this.models.Product.findById(e.product_id)})))),order.currency=this.data.currency.code,order.customer_id=this.data.customerId,order.contact_id=contact._id,order.customer_number=contact.customer_number,order.customer_email=contact.primary_email,order.billing_info=this.data.billing_info,order.shipping_info=this.data.shipping_info,order.is_business=!1,order.vat_number="",order.received_amount=this.data.amount,order.order_secret=__webpack_require__(3884)(),order.meta_data=this.data.meta_data,this.data.parent_order_id&&(order.parent_order_id=this.data.parent_order_id),seller_id&&(order.seller_id=seller_id),await order.save(),seller_id){const affiliateSeller=await this.models.AffiliateSeller.findById(seller_id).populate("profile_id"),productComission=affiliateSeller.profile_id.productCommissions&&affiliateSeller.profile_id.productCommissions.find((e=>e.product_id==order.items[0].product._id.toString()))?affiliateSeller.profile_id.productCommissions.find((e=>e.product_id==order.items[0].product._id.toString())).initialCommission:affiliateSeller.profile_id.initialCommission,commissionValue=this.data.receipt.totalWithoutVat*productComission/100,affiliateCommission=new this.models.AffiliateCommission({email:affiliateSeller.email,order_id:order._id,project_id:this.data.project_id,seller_id:affiliateSeller._id,affiliate_id:affiliateSeller.affiliate_id,value:round(commissionValue,2)});affiliateSeller.sales++,await affiliateSeller.save(),order.affiliate_comission+=round(commissionValue,2),await order.save();const af=await affiliateCommission.save(),createEvent=eval("require('@converdy/utils/create-event')");await createEvent({scope:"affiliateCommission",name:"created",payload:{comissionId:af._id.toString(),projectId:order.project_id.toString(),sellerId:affiliateSeller._id.toString(),orderValue:this.data.amount,commission:round(commissionValue,2),status:"pending"}})}contact.timeline.push({label:events.ORDER_CREATED,contactType:"customer",value:order.order_number})}else if(order=await this.models.Order.findById(this.data.parent_order_id),this.data.payment_method=order.payment_method,this.data.customerId=order.customer_id,seller_id=order.seller_id&&order.seller_id.toString(),seller_id){const affiliateSeller=await this.models.AffiliateSeller.findById(seller_id).populate("profile_id"),productComission=affiliateSeller.profile_id.productCommissions&&affiliateSeller.profile_id.productCommissions.find((e=>e.product_id==order.items[0].product._id.toString()))?affiliateSeller.profile_id.productCommissions.find((e=>e.product_id==order.items[0].product._id.toString())).recurringCommission:affiliateSeller.profile_id.recurringCommission,commissionValue=this.data.receipt.totalWithoutVat*productComission/100,affiliateCommission=new this.models.AffiliateCommission({email:affiliateSeller.email,order_id:order._id,project_id:this.data.project_id,seller_id:affiliateSeller._id,affiliate_id:affiliateSeller.affiliate_id,value:round(commissionValue,2)});affiliateSeller.sales++,await affiliateSeller.save();const af=await affiliateCommission.save(),createEvent=eval("require('@converdy/utils/create-event')");await createEvent({scope:"affiliateCommission",name:"created",payload:{comissionId:af._id.toString(),projectId:order.project_id.toString(),sellerId:affiliateSeller._id.toString(),orderValue:this.data.amount,commission:round(commissionValue,2),status:"pending"}})}await contact.save(),this.data.orderId=order._id,this.data.orderSecret=order.order_secret;const project=await this.models.Project.findById(this.data.project_id),invoice=new this.models.Invoice;invoice.project_id=order.project_id,invoice.funnel_id=order.funnel_id,invoice.order_id=order._id,invoice.customer_id=order.contact_id,invoice.is_original="subscriptionPayment"!=this.scope,invoice.seller_details={business_name:project.settings.invoicing_settings.legal_business_name,address_line1:project.settings.invoicing_settings.business_address.address_line1,address_line2:project.settings.invoicing_settings.business_address.address_line2,city:project.settings.invoicing_settings.business_address.city,postal_code:project.settings.invoicing_settings.business_address.postal_code,state:project.settings.invoicing_settings.business_address.state,country:project.settings.invoicing_settings.business_address.country,additional_address_info:project.settings.invoicing_settings.additional_address_info,tax_details:project.settings.invoicing_settings.tax_details},invoice.buyer_details=this.data.billing_info,invoice.currency=this.data.currency.code,invoice.line_items=this.data.receipt.items.map((e=>({quantity:1,name:e.name,price:e.totalWithoutVat,description:e.pricingName,vat_rate:e.vatRate,vat_amount:e.totalVat,total_price:e.total}))),invoice.status="open",this.data.paymentId&&(invoice.payment_id=this.data.paymentId),await invoice.save(),this.data.invoiceId=invoice._id,contact.timeline.push({label:events.INVOICE_CREATED,contactType:"customer",value:invoice.ref_number}),await contact.save();const transaction=new this.models.Transaction({project_id:this.data.project_id,funnel_id:this.data.funnel_id,order_id:order._id,invoice_id:invoice._id,customer_id:invoice.customer_id,type:"payment",is_original:"subscriptionPayment"!=this.scope,currency:this.data.currency.code,amount:this.data.amount,is_original:"subscriptionPayment"!=this.scope});await transaction.save(),this.data.transactionId=transaction._id;const search=eval("require('@converdy/utils/search')")(process.env.SEARCH_API_KEY,process.env.SEARCH_URL);"subscriptionPayment"!=this.scope&&await search("indexes/global/documents","POST",[{id:__webpack_require__(3884)(),title:`Order #${order.order_number}`,description:`Customer: ${contact.first_name} ${contact.last_name}, Items: ${invoice.line_items.map((e=>e.name)).join(",")}`,location:`Orders / Order #${order.order_number}`,projectId:order.project_id,link:`/orders/${order._id}`,category:"Orders",content:`${order.order_number} ${contact.primary_email}`}]),await search("indexes/global/documents","POST",[{id:__webpack_require__(3884)(),title:`Invoice #${invoice.ref_number}`,description:`Customer: ${contact.first_name} ${contact.last_name}, Items: ${invoice.line_items.map((e=>e.name)).join(",")}`,location:`Invoices / Invoices #${invoice.ref_number}`,projectId:order.project_id,link:`/invoices/${invoice._id}`,category:"Invoices",content:`${invoice.ref_number}`}]);const getHash=text=>{const shasum=eval("require('crypto')").createHash("sha1");return shasum.update(text),shasum.digest("hex")};await search("indexes/global/documents","POST",[{id:getHash(contact.primary_email+order.project_id),title:`Contact: ${contact.first_name} ${contact.last_name}`,description:`Email: ${contact.primary_email}`,location:`Contacts / ${contact.primary_email}`,projectId:order.project_id,link:`/contacts/details/${contact._id}`,category:"Contacts",content:""}]);break;case"updateIntegration":await this.currentStep.data.map.reduce(((acc,val)=>(__webpack_require__(7579)(acc,val.to,eval(val.from)),acc.markModified(val.to),acc)),await this.models.PaymentIntegration.findById(this.data.integrationId)).save();break;case"removeIntegration":await this.models.PaymentIntegration.deleteOne({_id:this.data.integrationId});break;case"addIntegration":const integration=await this.currentStep.data.map.reduce(((acc,val)=>(__webpack_require__(7579)(acc,val.to,eval(val.from)),acc)),new this.models.PaymentIntegration).save(),proj=await this.models.Project.findById(this.data.data?this.data.data.projectId:this.data.projectId);0==proj.settings.active_payment_integration_ids.length&&(proj.settings.active_payment_integration_ids=[integration._id],await proj.save());break;case"createSubscription":const pricingOptions=await Promise.all(this.data.order.items.map((e=>e.product.pricing_options.find((t=>t._id==e.pricing_option_id))))),subscriptions=pricingOptions.filter((e=>"sub"==e.type||"sp"==e.type));for(let i=0;i<subscriptions.length;i++){const moment=eval("require('moment')"),receipt=(await(await this.makeSimpleRequest(`${this.apiUrl}/public/payments/calculatePrice`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({project_id:this.data.order.project_id,is_sub:!0,funnel_id:this.data.order.funnel_id,billing_info:this.data.order.billing_info,shipping_info:this.data.order.shipping_info,coupon_code:this.data.order.coupon_code,items:this.data.order.items.map((e=>({product_id:e.product._id,pricing_option_id:e.pricing_option_id})))})})).json()).receipt,subscription=new this.models.Subscription,contact=await this.models.Contact.findById(this.data.order.contact_id);subscription.type=subscriptions[i].type,subscription.pricing_option=subscriptions[i],subscription.original_order_id=this.data.order._id,subscription.project_id=this.data.order.project_id,subscription.funnel_id=this.data.order.funnel_id,subscription.customer_id=this.data.order.contact_id,subscription.customer_email=contact.primary_email,subscription.name=receipt.items[0].name,subscription.currency=this.data.order.currency,subscription.items=this.data.order.items.map((e=>({product_id:e.product._id,pricing_option_id:e.pricing_option_id}))),subscription.charges=[],subscription.prev_charge={no_of_tries:0,status:"success"},subscription.remaining_number_of_payments=subscriptions[i].number_of_payments,subscription.number_of_payments=0,subscription.has_limited_payments=Boolean(subscriptions[i].number_of_payments),subscription.billing_frequency=subscriptions[i].billing_frequency,subscription.next_charge={date:moment().utc().add(subscription.billing_frequency.value,subscription.billing_frequency.unit).add(subscriptions[i].trial_period_days,"days").toDate(),amount:receipt.total},subscription.initial_charge=this.data.order.received_amount,await subscription.save();const hertzy=eval("require('hertzy')");hertzy.tune("checkout").emit("subscription:started",subscription)}break;case"runScript":const cb=script=>new Promise(((accept,reject)=>{const callback=accept;eval(script)}));for(let i=0;i<this.currentStep.data.scripts.length;i++)-1!=this.currentStep.data.scripts[i].indexOf("callback")?this.previousStepData={...this.previousStepData,...await cb(this.currentStep.data.scripts[i])}:eval(this.currentStep.data.scripts[i])}}async runBe(){return await(await this.makeSimpleRequest(this.apiUrl+"/public/payments/processNextStep",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(new PaymentProcessatorBase(this))})).json()}}module.exports=({paymentProviderId:e,paymentIntegration:t,scope:i,enviroment:r="fe",stepCount:a=1,data:n,credentials:s})=>new Promise((async(o,c)=>{let d=await new PaymentProcessator(new PaymentProcessatorBase({paymentProviderId:e,paymentIntegration:t,scope:i,enviroment:r,stepCount:a,data:n,credentials:s}));do{if(d.currentStep&&"be"==d.currentStep.platform&&"fe"==r){d.enviroment=d.currentStep.platform;const e=await d.runBe();"done"!=e.msg&&"unauthorized"!=e.msg&&"error"!=e.msg?d=await new PaymentProcessator(new PaymentProcessatorBase(e)):d.done=e}if(d.currentStep&&!d.done&&await d.processCurrentStep(),d.done||d.incrementStep(),d.currentStep&&"be"==d.currentStep.platform&&"fe"==r){d.enviroment=d.currentStep.platform;const e=await d.runBe();"done"!=e.msg&&"unauthorized"!=e.msg&&"error"!=e.msg?d=await new PaymentProcessator(new PaymentProcessatorBase(e)):d.done=e}}while(d.currentStep&&d.currentStep.platform==r&&!d.done);d.done?o(d.done):d.currentStep?o({paymentProviderId:d.paymentProviderId,paymentIntegration:d.paymentIntegration,scope:d.scope,enviroment:d.currentStep.platform,stepCount:d.currentStep.order,data:d.data,credentials:d.credentials}):o({msg:"done"})}))},4671:(e,t,i)=>{var r=i(4228),a=i(7559);e.exports=function(e,t){var i=a(e,t);return r(i)?i:void 0}},4856:(e,t,i)=>{var r=i(4671),a=function(){try{var e=r(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();e.exports=a},5097:e=>{e.exports=function(e,t){return e===t||e!=e&&t!=t}},5802:(e,t,i)=>{var r=i(3077),a=i(5097),n=Object.prototype.hasOwnProperty;e.exports=function(e,t,i){var s=e[t];n.call(e,t)&&a(s,i)&&(void 0!==i||t in e)||r(e,t,i)}},5870:(e,t,i)=>{var r=i(4671)(i(714),"Map");e.exports=r},5874:e=>{var t=Array.isArray;e.exports=t},6264:(e,t,i)=>{var r=i(8637);e.exports=function(e,t){var i=this.__data__;return this.size+=this.has(e)?0:1,i[e]=r&&void 0===t?"__lodash_hash_undefined__":t,this}},6450:(e,t,i)=>{var r=i(714)["__core-js_shared__"];e.exports=r},6766:(e,t,i)=>{var r=i(2405),a=i(8341),n=i(9644),s=i(3784),o=i(6264);function c(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=n,c.prototype.has=s,c.prototype.set=o,e.exports=c},6821:e=>{e.exports=function(){this.__data__=[],this.size=0}},7221:(e,t,i)=>{var r=i(9438),a=Array.prototype.splice;e.exports=function(e){var t=this.__data__,i=r(t,e);return!(i<0||(i==t.length-1?t.pop():a.call(t,i,1),--this.size,0))}},7477:(e,t,i)=>{var r=i(1200);e.exports=function(e){var t=r(this,e).delete(e);return this.size-=t?1:0,t}},7559:e=>{e.exports=function(e,t){return null==e?void 0:e[t]}},7579:(e,t,i)=>{var r=i(9435);e.exports=function(e,t,i){return null==e?e:r(e,t,i)}},7787:(e,t,i)=>{var r=i(5271),a=i(9400);e.exports=function(e){if(!a(e))return!1;var t=r(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}},7827:(e,t,i)=>{var r,a=i(6450),n=(r=/[^.]+$/.exec(a&&a.keys&&a.keys.IE_PROTO||""))?"Symbol(src)_1."+r:"";e.exports=function(e){return!!n&&n in e}},8071:(e,t,i)=>{var r=i(9006),a=i(2275),n=i(5874),s=i(975),o=r?r.prototype:void 0,c=o?o.toString:void 0;e.exports=function e(t){if("string"==typeof t)return t;if(n(t))return a(t,e)+"";if(s(t))return c?c.call(t):"";var i=t+"";return"0"==i&&1/t==-1/0?"-0":i}},8341:e=>{e.exports=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}},8487:(e,t,i)=>{var r=i(8910);function a(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var i=function(){var r=arguments,a=t?t.apply(this,r):r[0],n=i.cache;if(n.has(a))return n.get(a);var s=e.apply(this,r);return i.cache=n.set(a,s)||n,s};return i.cache=new(a.Cache||r),i}a.Cache=r,e.exports=a},8637:(e,t,i)=>{var r=i(4671)(Object,"create");e.exports=r},8910:(e,t,i)=>{var r=i(4069),a=i(7477),n=i(476),s=i(984),o=i(4136);function c(e){var t=-1,i=null==e?0:e.length;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=n,c.prototype.has=s,c.prototype.set=o,e.exports=c},9435:(e,t,i)=>{var r=i(5802),a=i(330),n=i(1908),s=i(9400),o=i(9628);e.exports=function(e,t,i,c){if(!s(e))return e;for(var d=-1,l=(t=a(t,e)).length,p=l-1,u=e;null!=u&&++d<l;){var m=o(t[d]),_=i;if("__proto__"===m||"constructor"===m||"prototype"===m)return e;if(d!=p){var h=u[m];void 0===(_=c?c(h,m,u):void 0)&&(_=s(h)?h:n(t[d+1])?[]:{})}r(u,m,_),u=u[m]}return e}},9438:(e,t,i)=>{var r=i(5097);e.exports=function(e,t){for(var i=e.length;i--;)if(r(e[i][0],t))return i;return-1}},9505:(e,t,i)=>{var r=i(2121),a=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,n=/\\(\\)?/g,s=r((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(a,(function(e,i,r,a){t.push(r?a.replace(n,"$1"):i||e)})),t}));e.exports=s},9628:(e,t,i)=>{var r=i(975);e.exports=function(e){if("string"==typeof e||r(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}},9644:(e,t,i)=>{var r=i(8637),a=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;if(r){var i=t[e];return"__lodash_hash_undefined__"===i?void 0:i}return a.call(t,e)?t[e]:void 0}}}]);